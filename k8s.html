<!DOCTYPE html><html><head>
      <title>k8s</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\user\.cursor\extensions\shd101wyy.markdown-preview-enhanced-0.8.13\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h3 id="kubernetes-concept">Kubernetes Concept </h3>
<p>I've been using <code>kubectl</code> commands to manage objects in a cluster; creating ingress, service, pod components, etc.<br>
But I've been lacking knowledge of what they are, how they are interconnected and how the client could access the cluster via endpoints.<br>
So I tried to understand each concept of component and why kubernetes is constructed that way.</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/overview/components/" target="_blank">Kubernetes doc</a></li>
<li><a href="https://www.youtube.com/watch?v=X48VuDVv0do&amp;t=1594s&amp;ab_channel=TechWorldwithNana" target="_blank">Techworld with Nana</a></li>
<li><a href="https://medium.com/devops-mojo/kubernetes-objects-resources-overview-introduction-understanding-kubernetes-objects-24d7b47bb018" target="_blank">Kubernetes — Objects</a></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"><img src="https://kubernetes.io/images/docs/components-of-kubernetes.svg" alt="add-node" width="820"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><em>components-of-kubernetes</em></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>Kubernetes Component</p>
<ul>
<li>Master Node runs the Control Plane Components and will manages overall state of the cluster.
<ul>
<li>kube-apiserver
<ul>
<li>exposes the Kubernetes API and provides the front end to the Control Plane.</li>
<li>entrypoint  for interacting with the k8s control plane</li>
<li>handles api requests, authentication, and authorization</li>
</ul>
</li>
<li>kube-scheduler
<ul>
<li>scans for newly created pods and assigns them nodes based on a variety of factors
<ul>
<li>including resource requirements, hardware/software constraints and data locality.</li>
</ul>
</li>
<li>distribute workloads across worker nodes</li>
</ul>
</li>
<li>kube-controller-manager
<ul>
<li>ensures the cluster remains in the desired state</li>
<li>run controllers which run loops to ensure the configuration matches actual state of the running cluster.</li>
<li>these controllers are as follows:
<ul>
<li>Node controller — Checks and ensures nodes are up and running</li>
<li>Job Controller — Manages one-off tasks</li>
<li>Endpoints Controller — Populates endpoints and joins services and pods.</li>
<li>Service Account and Token Controller — Creation of accounts and API Access tokens.</li>
</ul>
</li>
</ul>
</li>
<li>cloud-controller-manager</li>
<li>etcd
<ul>
<li>consistent and highly-available key-value store that maintains cluster state and ensures data consistency</li>
</ul>
</li>
</ul>
</li>
<li>Worker Nodes host the Pods which are the components of the application workload.
<ul>
<li>kubelet
<ul>
<li>agent running on each node</li>
<li>watches for changes in pod spec and takes action</li>
<li>ensures the pods running on the node are running and are healthy.</li>
</ul>
</li>
<li>kube-proxy
<ul>
<li>a daemon on each node that allows network rules such as load balancing and routing</li>
<li>enables communication between pods and external clients</li>
<li>Proxy network running on the node that manage the network rules</li>
<li>and communication across pods from networks inside or outside of the cluster.</li>
</ul>
</li>
<li>Container runtime
<ul>
<li>responsible for pulling images, creating containers</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Pod</p>
<ul>
<li>"Pods are the smallest deployable units of computing that you can create and manage in Kubernetes."</li>
<li>abstraction over container</li>
<li>usually 1 application(container) per pod</li>
<li>each pod gets its own ip address</li>
<li>ephermeral; new (unique) ip for each re-creation</li>
</ul>
</li>
<li>
<p>Service</p>
<ul>
<li>permanent ip address</li>
<li>Service provide stable IP address. Each pod has its own ip address, but are ephemeral.</li>
<li>Load balancing</li>
<li>loose coupling</li>
<li>within &amp; outside cluster</li>
<li>pods communite with each other using services</li>
</ul>
</li>
<li>
<p>ClusterIP services</p>
<ul>
<li>default type</li>
<li>microservice app deployed</li>
</ul>
</li>
<li>
<p>Ingress</p>
<ul>
<li><a href="https://my-app.com">https://my-app.com</a> -&gt; forward to service</li>
</ul>
</li>
<li>
<p>ConfigMap</p>
<ul>
<li>external configuration of your application</li>
<li><code>DB_URL = monngo-db</code></li>
</ul>
</li>
<li>
<p>Secret</p>
<ul>
<li><code>DB_USER = mongo-user</code></li>
<li><code>DB_PW = mongo-pw</code></li>
</ul>
</li>
<li>
<p>Volume (external hdd)</p>
<ul>
<li>on Local</li>
<li>on Remote, outside of the cluster</li>
<li>k8s does not manage data persistence</li>
</ul>
</li>
</ul>
<p>What if pod dies =&gt; Use multi-node and pod replicas(deployment as abstraction for pods)<br>
, use service as a load balancer.</p>
<ul>
<li>
<p>Deployemnt for stateless apps</p>
</li>
<li>
<p>StatefulSet for stateFul apps or databases</p>
<ul>
<li>DB can't be replicated via deployment.</li>
<li>Avoid data inconsistencies</li>
<li>=&gt; StatefulSet for STATEFUL apps. e.g. mysql, mongodb, elastic search</li>
<li>But deploying StatefulSet is not easy</li>
<li>NOTE DB are often hosted outside of k8s cluster</li>
</ul>
</li>
<li>
<p>Worker node has multiple pods on it and 3 processes must be installed on every Node</p>
<ul>
<li>Container runtime (e.g. containerd)</li>
<li>kublet: schedules pods and containers
<ul>
<li>interacts with both the container and node</li>
<li>starts the pod with a container inside</li>
</ul>
</li>
<li>kube proxy:
<ul>
<li>forwards requests to services to pods</li>
<li>intelligent and performant forwarding logic that distributes request to pods with low network overhead
<ul>
<li>it can forward pod request for a service into the pod in the same node instead of forwarding to pods in other nodes, therefore lowers possible network overhead.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Master node, master processes</p>
<ul>
<li>schedule pod</li>
<li>monitor resources</li>
<li>re-schedule/re-start pod</li>
<li>join a new Node</li>
<li>4 process run on every Master node
<ul>
<li>Api server
<ul>
<li>cluster gateway</li>
<li>acts as a gatekeeper for authentication
<ul>
<li>request -&gt; api server -&gt; validates request -&gt; other processes -&gt; pod creation</li>
<li>1 entrypoint in to the cluster</li>
</ul>
</li>
</ul>
</li>
<li>Scheduler
<ul>
<li>schedule new pod -&gt; api server -&gt; scheduler</li>
<li>-&gt; where to put the pod(intelligently decide based on resource percentage of nodes being used)</li>
</ul>
</li>
<li>Controller manager
<ul>
<li>detect cluster state changes(pods state)</li>
<li>Controller Manager(detect pod state) -&gt; Scheduler -&gt; Kublet(on worker node)</li>
</ul>
</li>
<li>etcd
<ul>
<li>cluster brain!</li>
<li>key-value data store of cluster state</li>
<li>cluster changes get stored in the key value store!</li>
<li>Is the cluster healthy? What resources are available? Did the cluster state change?</li>
<li>NO application data is stored in etcd!</li>
<li>can be replicated</li>
<li>Multiple master nodes for secure storage
<ul>
<li>api server is load balanced</li>
<li>distributed storage across all the master nodes</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Example of Cluster Set-up</p>
<ul>
<li>2 Master nodes, 3 Worker nodes</li>
<li>Master node : less resources</li>
<li>Worker node : more resources for running applications</li>
<li>can add more Master or Worker nodes</li>
</ul>
</li>
<li>
<p>Minikube</p>
<ul>
<li>master and worker process run on a single node</li>
<li>usually via virtual box or other hypervisor</li>
<li>for testing purposes</li>
</ul>
</li>
<li>
<p>deployment</p>
<ul>
<li>blueprint for creating pods</li>
<li>most basic configuration for deployemnt (name and image to use)</li>
<li>rest defaults</li>
</ul>
</li>
<li>
<p>replicaset</p>
<ul>
<li>another abstraction of layer</li>
<li>manages the replicas of a pod</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>k create deployment nginx-depl <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:alpine
k get replicaset
</code></pre><ul>
<li>Layers of Abstraction
<ul>
<li>Deployment : manages a replicaset</li>
<li>ReplicaSet : manages replicas of pods</li>
<li>Pod : is an abstraction of containers</li>
<li>Container</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code><span class="token comment"># edit deployement, but not pod directly</span>
k edit deployment nginx-depl
</code></pre><ul>
<li>
<p>YAML configuration file</p>
<ul>
<li>Attributes of <code>spec</code> are specific to the <code>kind</code></li>
<li>each configuration file has 3 parts
<ul>
<li>metadata</li>
<li>specification</li>
<li>status: automatically generated by k8s (desired ==? actual) self-healing feature
<ul>
<li>k8s gets this status from <code>etcd</code>!</li>
</ul>
</li>
</ul>
</li>
<li>Store the YAML config file with your code (git repository)</li>
<li><code>template</code> also has its own <code>metadata</code> and <code>spec</code>: applies to Pod
<ul>
<li>blueprint for a Pod</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Connecting the component</p>
<ul>
<li>labels &amp; selectors</li>
<li><code>metadata</code> contains labels, <code>spec</code> contains selectors
<ul>
<li>metadata define key-value pair for label which is matched by the spec selector for pod</li>
<li>pod gets the label through the spec.template blueprint</li>
<li>pod belongs to deployment by label</li>
<li>deployment labels are connected to service's spec.selector</li>
<li>service's spec.selector uses deployment's metadata labels to make connection to deployement(pods)</li>
</ul>
</li>
<li>service expose port (accessible) -&gt; forward to service targetPort -&gt; deployment's containerPort</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> fe<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>deployment
  <span class="token comment"># NOTE label for deployment which is used by service to make connection to deployement(pods)</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> fe<span class="token punctuation">-</span>nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token comment"># NOTE allows `Deployment` to find and manage Pods with this matching label</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> fe<span class="token punctuation">-</span>nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token comment"># NOTE sets the labels for the `Pods` created by the Deployment.</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> fe<span class="token punctuation">-</span>nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> fe<span class="token punctuation">-</span>nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> jnuho/fe<span class="token punctuation">-</span>nginx<span class="token punctuation">:</span>latest
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token comment">#imagePullSecrets:</span>
      <span class="token comment">#- name: regcred</span>
</code></pre><pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>k describe svc serivceName
  Endpoints: podip:targetPort
  <span class="token builtin class-name">:</span> this Endpoint <span class="token function">ip</span> matches pod <span class="token function">ip</span>

k get pod podName <span class="token parameter variable">-o</span> wide
k get deploy nginx-depl <span class="token parameter variable">-o</span> yaml
  check the status is automatically generated by k8s
  retrieve result of status from etcd
</code></pre><ul>
<li>
<p>Complete Application setup with Kubernetes components</p>
<ul>
<li>mongodb(internal service; no external requests), mongo-express(Web-app)</li>
<li>mongo express get url,id, pw from configmap and secret to connect to mongodb</li>
<li>mongo express accessible from browser: NodeIp:PortOfExternalService</li>
<li>2 Deployment / Pod</li>
<li>2 Service</li>
<li>1 ConfigMap</li>
<li>1 Secret</li>
<li>Browser -&gt; mongo express external service -&gt; mongoexpress pod -&gt; mongodb internal service -&gt; mongodb pod</li>
</ul>
</li>
<li>
<p>Namespace</p>
<ul>
<li>kube-system: system processes, master and kubectl processes</li>
<li>kube-public: publicly accessible data, configmap, that contains cluster information <code>k cluster-info</code></li>
<li>kube-node-lease: heartbeats of node, determines the availability of a node</li>
<li>default: resources you create</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>kubectl create namespace myNameSpace
</code></pre><ul>
<li>
<p>Group applications into namespaces</p>
<ul>
<li>e.g. database/ logging / monitoring/ nginx-ingress/elastic stack</li>
<li>no need to create namespaces for smaller projects with about 10 users</li>
<li>create namespaces if there are many teams, same application(same name)</li>
<li>staging/development namespace resources use same resource in certain namespaces</li>
<li>blue/green deployment using namespaces (Production green/blue)</li>
<li>access and resource limits on nameaspaces</li>
</ul>
</li>
<li>
<p>Each NS must define own ConfigMap/Secret</p>
<ul>
<li>suppose projectA, projectB namespaces</li>
<li>both namespace must have ConfigMap with exact same content</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">db_url</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>service.database
</code></pre><ul>
<li>Components, which can't be created within a namespace
<ul>
<li>persistent volume</li>
<li>node</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>k api-resources <span class="token parameter variable">--namespaced</span><span class="token operator">=</span>false
k api-resources <span class="token parameter variable">--namespaced</span><span class="token operator">=</span>true
</code></pre><ul>
<li>You can change the active namespace with kubens
<ul>
<li>without a need to <code>k get pod -n myNameSpace</code></li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>brew <span class="token function">install</span> kubectx
kubens
kubens my-namespace
  Active namespace is <span class="token string">"my-namespace"</span>
</code></pre><ul>
<li>Ingress
<ul>
<li><a href="https://traefik.io/glossary/kubernetes-ingress-and-ingress-controller-101/#:~:text=A%20Kubernetes%20ingress%20controller%20follows,state%20requested%20by%20the%20user">ingress by traefik.io</a></li>
<li><a href="https://thenewstack.io/deploy-a-multicluster-ingress-on-google-kubernetes-engine/?ref=traefik.io">gke ingress</a></li>
<li><a href="https://medium.com/@rehmanabdul166/explaining-load-balancers-and-ingress-controller-a-powerful-duo-bca7add558ab">load balancer and ingress duo</a></li>
<li><a href="https://medium.com/@thekubeguy/load-balancer-vs-ingress-why-do-we-need-both-for-same-work-3ae2b9afdd5a">load balancer vs. ingress</a></li>
</ul>
</li>
</ul>
<p>Let's walk through the flow of traffic in a Kubernetes environment with Ingress, an Ingress Controller, and an external Load Balancer (such as an Application Load Balancer, ALB):</p>
<ol>
<li>
<p><strong>Ingress Creation</strong>:</p>
<ul>
<li>You start by creating an Ingress resource in your Kubernetes cluster.</li>
<li>The Ingress defines routing rules based on HTTP hostnames and URL paths.</li>
</ul>
</li>
<li>
<p><strong>External Load Balancer (ELB) Creation</strong>:</p>
<ul>
<li>When you create an Ingress, the cloud environment (e.g., AWS) automatically provisions an external Load Balancer (e.g., ALB).</li>
<li>The ELB acts as the entry point for external traffic.</li>
</ul>
</li>
<li>
<p><strong>Traffic Flow</strong>:</p>
<ul>
<li>Here's how the traffic flows:
<ul>
<li><strong>External Client</strong>: Sends a request to the ALB (Load Balancer).</li>
<li><strong>ALB</strong>: Receives the request and forwards it to the Ingress Controller.</li>
<li><strong>Ingress Controller</strong>: Based on the Ingress rules, the controller routes the request to the appropriate Kubernetes Service.</li>
<li><strong>Service</strong>: The Service forwards the request to the corresponding Pod(s).</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>So, the complete flow is: <strong>ALB → Ingress Controller → Ingress → Service → Pod</strong>.</p>
<p>Ingress allows fine-grained routing, and the Ingress Controller ensures that the load balancer routes requests correctly. If you need more complex routing based on HTTP criteria, Ingress is a powerful tool! 🚀</p>
<ol>
<li>Use External Service: <a href="http://my-node-ip">http://my-node-ip</a>:svcNodePort -&gt; Pod</li>
</ol>
<ul>
<li>service.spec.type=LoadBalancer, nodePort=30510</li>
<li><a href="http://localhost:30510/">http://localhost:30510/</a>
<ul>
<li>in VirtualBox port-forward 30510</li>
</ul>
</li>
</ul>
<ol start="2">
<li>Use <code>Ingress</code> + Internal service: <a href="https://my-app.com">https://my-app.com</a></li>
</ol>
<ul>
<li>Ingress Controller Pod -&gt; Ingress (routing rule) -&gt; Service -&gt; Pod</li>
<li>using ingress, you can configure https connection</li>
</ul>
<ol>
<li>External Service (without Ingress)</li>
</ol>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>external<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
  <span class="token comment"># LoadBalancer : opening to public</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30510</span>
</code></pre><ol start="2">
<li>Using Ingress -&gt; internal Service (e.g. <code>myapp-internal-service</code>)</li>
</ol>
<ul>
<li>internal service has no <code>nodePort</code> and the type should be <code>type: ClusterIP</code></li>
<li>must be valid domain address</li>
<li>map domain name to Node's IP address, which is the entrypoint
<ul>
<li>(one of the nodes or could be a host machine outside the cluster)</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token comment"># incoming requests are forwarded to the internal service</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>internal<span class="token punctuation">-</span>service
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>internal<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre><ul>
<li>
<p>Ingress controller</p>
<ul>
<li>implementation of ingress, which is Ingress Controller (Pod)</li>
<li>evaluates and processes ingress rules</li>
<li>manages redirections</li>
<li>entrypoint to cluster</li>
<li>many third party implementations
<ul>
<li>e.g. k8s Nginx Ingress Controller</li>
</ul>
</li>
<li>HAVE TO CONSIDER the environemnt where the k8s cluster is running
<ul>
<li>Cloud Service Provider (AWS, GCP, AZURE)
<ul>
<li>External reqeust from the browser -&gt;
<ul>
<li>Cloud Load balancer -&gt;</li>
<li>Ingress Controller Pod -&gt;</li>
<li>Ingress -&gt;</li>
<li>Service -&gt;</li>
<li>Pod</li>
</ul>
</li>
<li>using cloud lb, you do not have to implement load balancer yourself</li>
</ul>
</li>
<li>Baremetal
<ul>
<li>you need to configure some kind of entrypoint (e.g. metallb)</li>
<li>either inside of cluster or outside as separate server</li>
<li>software or hardware solution can be used</li>
<li>must provide entrypoint</li>
<li>e.g. Proxy Server: public ip address and open ports
<ul>
<li>Proxy server -&gt; Ingress Controller Pod -&gt; Ingress (checks ingress rules) -&gt; Service -&gt; Pod</li>
<li>no server in k8s cluster is publicly accessible from outside</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Minikube ingress implementation</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code><span class="token comment"># nginx implementation of ingress controller</span>
minikube addons <span class="token builtin class-name">enable</span> ingress

k get pod <span class="token parameter variable">-n</span> kube-system
  nginx-ingess-controller-xxx

</code></pre><ul>
<li>configure ingress rule for kubernetes dashboard componnent
<ul>
<li>minikube in default creates dashboard service (minikube specific)</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>k get ns
  kubernetes-dashboard Active 17d

k get all <span class="token parameter variable">-n</span> kubernetes-dashboard
  pod
  svc
</code></pre><ul>
<li>dashboard-ingress.yaml</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> dashboard.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token comment"># forward to service name created in minikube</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre><ul>
<li>create ingress rule for kubernetes-dashboard</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>k apply <span class="token parameter variable">-f</span> dashboard-ingress.yaml

k get ingress <span class="token parameter variable">-n</span> kubernetes-dashboard <span class="token parameter variable">--watch</span>
  NAME               CLASS   HOSTS             ADDRESS        PORTS   AGE
  dashboard-ingress  nginx   dashboard.com     <span class="token number">192.168</span>.49.2   <span class="token number">80</span>      42s

<span class="token function">vim</span> /etc/hosts
  <span class="token number">192.168</span>.49.2 dashboard.com

<span class="token comment"># check in chrome browser:</span>
<span class="token comment"># http://dashboard.com</span>

k describe ingress dashboard-ingress <span class="token parameter variable">-n</span> kubernetes-dashboard

  <span class="token comment"># whenever there's a request into the cluster, there's no rule for mapping the request to service, then</span>
  <span class="token comment"># this backend is default to handle the request. e.g. 404 not found</span>
  <span class="token comment"># one can define custom error page</span>
  <span class="token comment"># SIMPLY CREATE A SERVICE WITH THE SAME NAME: default-http-backend</span>
  Default backend: default-http-backend:80
</code></pre><ul>
<li>Define custom <code>default-http-backend</code></li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>http<span class="token punctuation">-</span>backend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>response<span class="token punctuation">-</span>app
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token comment"># this is the port that receives the default backend response</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre><ul>
<li>
<p>ingress rules</p>
</li>
<li>
<p>multiple paths for the same host</p>
<ul>
<li><a href="http://myapp.com/analytics">http://myapp.com/analytics</a></li>
<li><a href="http://myapp.com/shopping">http://myapp.com/shopping</a></li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>fanout<span class="token punctuation">-</span>example
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span> /
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> myapp.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /analytics
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> analytics<span class="token punctuation">-</span>service
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">3000</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /shopping
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> shopping<span class="token punctuation">-</span>service
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre><ul>
<li>multiple hosts
<ul>
<li><a href="http://analytics.myapp.com">http://analytics.myapp.com</a></li>
<li><a href="http://shopping.myapp.com">http://shopping.myapp.com</a></li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>fanout<span class="token punctuation">-</span>example
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span> /
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> analytics.myapp.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> analytics<span class="token punctuation">-</span>service
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">3000</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> shopping.myapp.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> shopping<span class="token punctuation">-</span>service
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre><ul>
<li>Ingress that includes configuration of TLS certificate
<ul>
<li>Secret component : define yaml to create one
<ul>
<li>tls.crt, tls.key : values are actual file contents, NOT file paths/locations</li>
<li>Secret must bein the same namepsace as the Ingress Component</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tls<span class="token punctuation">-</span>example<span class="token punctuation">-</span>ingresss
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment">########## TLS SETTING ##########</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> myapp.com
    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>secret<span class="token punctuation">-</span>tls
  <span class="token comment">########## TLS SETTING ##########</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> myapp.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>internal<span class="token punctuation">-</span>service
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>secret<span class="token punctuation">-</span>tls
  namespace<span class="token punctuation">:</span>default
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls.crt</span><span class="token punctuation">:</span> base64 encoded cert
  <span class="token key atrule">tls.key</span><span class="token punctuation">:</span> base64 encoded key
<span class="token key atrule">type</span><span class="token punctuation">:</span> kubernetes.io/tls
</code></pre><ul>
<li>
<p>Helm explained</p>
<ul>
<li>package manage (e.g. apt)</li>
</ul>
</li>
<li>
<p>Helm for Elastic Search Stack for Logging</p>
</li>
<li>
<p>requirement: yamls for</p>
<ul>
<li>Stateful Set</li>
<li>ConfigMap</li>
<li>Secret</li>
<li>K8s User with permissions</li>
<li>Services</li>
</ul>
</li>
<li>
<p>First, helm provide packages for those to be used by anyone</p>
<ul>
<li>install bundle of yamls</li>
<li>create your own helm charts with helm</li>
<li>push them to helm repository</li>
<li>download and use existing ones</li>
<li>e.g. database apps, monitoring apps(prometheus)</li>
<li>sharing helm charts is available</li>
<li>you can download reuse that configuration</li>
<li><code>helm search &lt;keyward&gt;</code></li>
<li>public/private helm registries</li>
</ul>
</li>
<li>
<p>Second, helm as a templating engine</p>
<ul>
<li>for CI/CD: in your build, you can replace the values on the fly</li>
<li>Define a template with common attributes for many configurations
<ul>
<li>a common blueprint defined as a template YAML config</li>
<li>dynamic values are replaced by placeholders; <code>values.yaml</code>
<ul>
<li>values injection into template files</li>
</ul>
</li>
</ul>
</li>
<li>Same applications across different environments</li>
</ul>
</li>
<li>
<p>Helm chart structure</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="" class="language-text"><code>tree

mychart/        # name of the chart
  Chart.yaml    # meta info about chart: name,version,dependencies
  values.yaml   # values for the template files(can be overridden)
  charts/       # chart dependencies
  templates/    # template files
  READEME.md
  LICENSE

helm install &lt;chartname&gt;

# override values.yaml default values by:
# values.yaml + my-value.yaml =&gt; result
helm install --values=my-values.yaml &lt;chartname&gt;
helm install --set version=2.0.0

# BETTER TO HAVE my-values.yaml and values.yaml instead of `set`
</code></pre><ul>
<li>
<p>helm release management</p>
</li>
<li>
<p>version2 vs. version3</p>
</li>
<li>
<p>version2:</p>
<ul>
<li>client  (cli)</li>
<li>server (tiller)</li>
<li>helm install(cli) -&gt; tiller execute yaml and deploy the cluster</li>
<li>helm install/upgrade/rollback -&gt; tiller create history with revision
<ul>
<li>revision 1,2... history is stored</li>
<li>downsides: tiller has too much power inside of k8s cluster
<ul>
<li>security risk</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>version3: removed tiller for such security risk</p>
</li>
<li>
<p>Volumes</p>
<ul>
<li>Persistent Volume</li>
<li>Persistent Volume Claim</li>
<li>Storage class</li>
</ul>
</li>
<li>
<p>need for volumes</p>
<ul>
<li>k8s no data persistence out of the box!</li>
<li>requires storage that doesn't depend on the pod lifecycle</li>
<li>storage must be available on all nodes</li>
<li>need to survive even if node/cluster crushes; highly available
<ul>
<li>outside of cluster?</li>
</ul>
</li>
<li>writes/reads to directory</li>
</ul>
</li>
<li>
<p>Persistent volume</p>
<ul>
<li>cluster resources used to storage data</li>
<li>defined by YAML</li>
<li><code>spec</code>: how much storage</li>
<li>need actual physical sotrage:</li>
<li>persistent volume does not care about your actual storage
<ul>
<li><code>pv</code> simply provides interface to the actual storage</li>
<li>it's like an external plugin to your cluster</li>
</ul>
</li>
<li>could be hybrid: multiple storage types
<ul>
<li>one application uses local disk/nfs server/cloud stroages, etc.</li>
</ul>
</li>
<li>in YAML for <code>pv</code>, specify in <code>spec</code>, which physical storage to use</li>
</ul>
</li>
<li>
<p>Check types of vlumes in k8s document</p>
</li>
<li>
<p>gcp cloud storage</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>volume
  <span class="token key atrule">failure-domain.beta.kubernetes.io/zone</span><span class="token punctuation">:</span> us<span class="token punctuation">-</span>central1<span class="token punctuation">-</span>a__us<span class="token punctuation">-</span>central1<span class="token punctuation">-</span>b
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 400Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">gcePersistentDisk</span><span class="token punctuation">:</span>
    <span class="token key atrule">pdName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>data<span class="token punctuation">-</span>disk
    <span class="token key atrule">fsType</span><span class="token punctuation">:</span> ext4
</code></pre><ul>
<li>local storage</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>pv
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 100Gi
  <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Delete
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>storage
  <span class="token key atrule">local</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /mnt/disks.ssd1
  <span class="token key atrule">modeAffinity</span><span class="token punctuation">:</span>
    <span class="token key atrule">required</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/hostname
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
          <span class="token key atrule">values</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> example<span class="token punctuation">-</span>node
</code></pre><ul>
<li>
<p>Persistent Volumes are NOT namespaced</p>
<ul>
<li>PV outside of the namesapces</li>
<li>accessible to the whole cluster</li>
</ul>
</li>
<li>
<p>Local vs. Remote volume types</p>
<ul>
<li>each volume type has it's own use case!</li>
<li>local volume types violoate 2. and 3. requirement for data persistence:
<ul>
<li>(X) Being tied to 1 specific node</li>
<li>(X) Surviving cluster crashes</li>
</ul>
</li>
</ul>
</li>
<li>
<p>For DB persistence, almost always use REMOTE STORAGE!!!</p>
</li>
<li>
<p>StatefulSet</p>
<ul>
<li>What is it and why it is used?</li>
<li>how <code>StatefulSet</code> differs from <code>Deployment</code>?</li>
<li>specifically for stateful appliations!
<ul>
<li>e.g. stateful apps: database apps</li>
<li>e.g. stateless apps: don't keep record of state, each request is completely new</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Stateful and stateless applications example</p>
<ul>
<li>nodejs(stateless) + mongodb(stateful)</li>
<li>http request (doesn't depend on previous data to handle)-&gt; nodejs
<ul>
<li>handle it based on the payload of request</li>
<li>update/query from mongodb app</li>
</ul>
</li>
<li>mongodb update data based on previous state / query data
<ul>
<li>depends on most up-to-date data/state</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Stateless apps are deployed using <code>Deployment</code> component</p>
</li>
<li>
<p>Stateful apps are deployed using <code>StatefulSet</code> component</p>
</li>
<li>
<p>Both <code>Deployment</code> and <code>StatefulSet</code> manage pods based on container specification!</p>
</li>
<li>
<p>K8s Services</p>
<ul>
<li>ClusterIP</li>
<li>NodePort</li>
<li>LoadBalancer</li>
<li>Headless</li>
</ul>
</li>
<li>
<p>each pod has its own ip address</p>
</li>
<li>
<p>pods are ephermeral - are descroyed frequently!</p>
</li>
<li>
<p>service provides stable ip address.</p>
</li>
<li>
<p>service does load balancing into pods</p>
</li>
<li>
<p>loose coupling</p>
</li>
<li>
<p>within &amp; outside cluster</p>
</li>
<li>
<p>ClusterIP Services</p>
<ul>
<li>default type</li>
<li>e.g. microservices app deployed
<ul>
<li>in pod : app container(3000)+sidecar container (9000: collects logs)</li>
<li>pod assgiend in node ip range: 10.2.2.5 (started on node2)</li>
<li>where node1: 10.2.1.x</li>
<li>where node2: 10.2.2.x</li>
<li>where node3: 10.2.3.x</li>
<li><code>k get pod -o wide</code> to check pod ip</li>
<li>Ingress -&gt; Service(ClusterIP) -&gt; Pods</li>
<li>Sevice's <code>spec.selector</code> : which Pods it forward to</li>
<li>Sevice's <code>spec.ports.targetPort</code> : which Ports it forward to</li>
<li>Pods are identified via selectors
<ul>
<li>key value pairs for selctor</li>
<li>Pod: <code>spec.template.metadata.labels</code></li>
<li>Service: <code>spec.selector</code>
<ul>
<li>service forwards request to matching Pods</li>
</ul>
</li>
</ul>
</li>
<li>Service Endpoint is CREATED with the same name as Service</li>
<li>keeps track of which Pods are the members/endppoints of the Service</li>
<li>each time pods recreated, Endpoints are also updated to track that</li>
<li>Service <code>spec.ports.port</code>: can be arbitrary</li>
<li>Service <code>spec.ports.targetPort</code>: MUST MATCH deployment's Pod <code>containerPort</code></li>
<li>Multi-port services (two container specified in deployment.yaml)
<ul>
<li>mongo-db application 27017</li>
<li>mongo-db exporter (Prometheus) 9216
<ul>
<li>Prometheus scapes data from mododb-exporter via port 9216</li>
</ul>
</li>
</ul>
</li>
<li>service have to handle two requests via two ports 27017, 9216</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> microservice<span class="token punctuation">-</span>one
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token comment"># ...</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> microservice<span class="token punctuation">-</span>one
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ms<span class="token punctuation">-</span>one
        <span class="token key atrule">image</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>private<span class="token punctuation">-</span>repo/ms<span class="token punctuation">-</span>one<span class="token punctuation">:</span>latest
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>collector
        <span class="token key atrule">image</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>private<span class="token punctuation">-</span>repo/log<span class="token punctuation">-</span>collector<span class="token punctuation">:</span>latest
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>
</code></pre><ul>
<li>Multi-port service</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>exporter
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9216</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9216</span>
</code></pre><ul>
<li>
<p>Headless Service</p>
<ul>
<li>Client wants to communicate with 1 specific Pod directly</li>
<li>Pods want to talk directly with specific Pod</li>
<li>So, not randomly selected (no Load balancing)</li>
<li>Use case: <code>Stateful</code> applications
<ul>
<li>such as databases(mysql,mongodb, elasticsearch)</li>
<li>Pods replicas are not identical</li>
<li>Only Master Pod is allowed to write to DB (write/read)</li>
<li>Worker Pods are for only (read)</li>
<li>Worker Pods must connect to Master Pod to sync their data after Master Pods made changes to the data</li>
<li>When a Worker Pod is created, it must clone the most recent Worker Pod</li>
</ul>
</li>
<li>Client need to figure out IP addresses of each Pod
<ul>
<li>Option 1: API call to k8s API Server?
<ul>
<li>list of pods and ip addresses</li>
<li>too tied to k8s api and inefficient</li>
</ul>
</li>
<li>Option 2: DNS lookup
<ul>
<li>k8s allows client to discover Pod ip addresses</li>
<li>DNS lookup for service - returns single IP address which belongs to a Service (ClusterIP address)</li>
</ul>
</li>
<li>BUT setting <code>sepc.cluseterIP</code> to <code>None</code> returns Pod IP address instead!!!</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Define headless Service:</p>
<ul>
<li>NO CLUSTER IP address is assigned!!!</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>service<span class="token punctuation">-</span>headless
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>
</code></pre><ul>
<li>
<p>Two services exist alongside each other</p>
<ul>
<li><code>mongodb-service</code></li>
<li><code>mongodb-service-headless</code></li>
</ul>
</li>
<li>
<p>Use headles service when client needs to perform write into mongodb Master Pod or for Pods to talk to each other for data synchronization</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>k get svc

NAME                     TYPE       CLUSTER-IP EXTERNAL-IP PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>
mongodb-service-headless ClusterIP  None       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>      <span class="token number">27017</span>/TCP
</code></pre><ul>
<li>3 Service <code>type</code>
<ul>
<li>ClusterIP: default, internal service, only accessible within cluster
<ul>
<li>no external traffic can directly address the ClusterIP service</li>
</ul>
</li>
<li>NodePort: accessible on a static port on each worker node in cluster
<ul>
<li>External traffic has access to fixed port on each Worker Node</li>
<li><code>nodePort</code> range should be: 30000 - 32767</li>
<li><code>http://ip-address-worker-node:nodePort</code></li>
<li>When you create NodePort Service, ClusterIP Service is also automatically created because nodePort has to be routed to <code>port</code> of Service
<ul>
<li><code>nodePort</code> -&gt; <code>port</code></li>
<li>e.g.  <code>port:3200</code>, <code>nodePort:30008</code>
<ul>
<li>cluster-ip:3200</li>
<li>node-ip:30008</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>LoadBalancer
<ul>
<li>LoadBalancer(Cloud providers')</li>
<li>AWS, GCP, AZURE</li>
<li>When Service of type LoadBalancer is created,
<ul>
<li>NodePort and ClusterIP Service are created automatically!</li>
<li>nodeport is not accessible directly from external browser
<ul>
<li>instead via LoadBalancer!!!</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ms<span class="token punctuation">-</span>service<span class="token punctuation">-</span>loadbalancer
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> microservice<span class="token punctuation">-</span>one
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3200</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
      <span class="token comment"># only via LoadBalancer though!</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30010</span>
</code></pre><ul>
<li>
<p>LoadBalancer &gt; NodePort &gt; ClusterIP</p>
<ul>
<li>LoadBalancer Service is an extension of NodePort Service</li>
<li>NodePort Service is an extension of ClusterIP Service</li>
</ul>
</li>
<li>
<p>Wrap-up</p>
<ul>
<li>NodePort Service NOT for external connection! TEST-ONLY</li>
<li>two common practice:
<ul>
<li>Ingress -&gt; Service (ClusterIP)</li>
<li>LoadBalanceri -&gt; Service (ClusterIP)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="kubernetes-networking">Kubernetes Networking </h3>
<ul>
<li>
<p><a href="https://medium.com/google-cloud/understanding-kubernetes-networking-pods-7117dd28727">Medium Post</a></p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-networking-terminology-interfaces-and-protocols">Networking terminology</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/understanding-ip-addresses-subnets-and-cidr-notation-for-networking">Networking - IP, Subnets, CIDR</a></li>
</ul>
</li>
<li>
<p>Kubernetes</p>
<ul>
<li>컨테이너 오케스트레이션 플랫폼으로 컨테이너 어플리케이션 deploy, manage, scaling 프로세스 자동화</li>
<li>Kubernetes clusters : 리눅스 컨테이너 호스트를 cluster로 그룹화하고 관리
<ul>
<li>on-premise, public/private/hybrid clouds에 적용가능</li>
<li>바른 스케일링이 필요한 cloud-native 어플리케이션에 적합한 플랫폼</li>
</ul>
</li>
<li>클라우드 앱 개발시 optimization에 유용</li>
<li>physical 또는 VM 클러스터에 컨테이너들을 scheduling 하고 run 할 수 있음</li>
<li>클라우드 네이티브 앱을 '쿠버네티스 패턴'을 이용하여 쿠버네티스를 런타임 플랫폼으로 사용하여 만들수 있음</li>
<li>추가 기능으로:
<ul>
<li>여러호스트에 걸쳐서 컨테이너를 Orchestrate 할 수 있음</li>
<li>엔터프라이즈 앱실행을 위해 리소스를 최대화하여 하드웨어 운용 가능</li>
<li>어플리케이션 배포와 업데이트를 제어 및 자동화</li>
<li>Stateful 앱을 실행 하기 위해 스토리지를 마운트 하고 추가 가능</li>
<li>컨테이너 애플리케이션과 리소스를 scaling 할 수 있음</li>
</ul>
</li>
<li>쿠버네티스는 다른 프로젝트들과 결합하여 효율적인 사용
<ul>
<li>Registry: Docker Registry</li>
<li>Networking</li>
<li>Telemetry</li>
<li>Security: LDAP, SELinux,RBAC, OAUTH with multitenancy layers</li>
<li>Automation</li>
<li>Services</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Kubernetes Architecture</p>
<ul>
<li><a href="https://devopscube.com/wp-content/uploads/2022/12/k8s-architecture.drawio-1.png">image1</a></li>
<li><a href="https://www.redhat.com/rhdc/managed-files/kubernetes_diagram-v3-770x717_0_0_v2.svg">image2</a></li>
</ul>
</li>
<li>
<p>TERMS</p>
<ul>
<li>Control Plane
<ul>
<li>쿠버네티스 노드들을 컨트롤하는 프로세스의 집합</li>
<li>여기서 모든 Task 할당이 이루어 짐</li>
</ul>
</li>
<li>Node : 컨트롤 Plane으로 부터 할당된 Task를 수행하는 머신</li>
<li>Pod: 1개의 Node에 Deploy된 한개 이상의 컨테이너들
<ul>
<li>파드에 있는 컨테이너들은 IP 주소, IPC (inter-process-communication), Hostname, 리소스</li>
</ul>
</li>
<li>Replication 컨트롤러 : 몇개의 동일 pod 카피들이 클러스터에서 실행되어야 하는지 컨트롤</li>
<li>Service : Pods로부터 work definition을 분리함.
<ul>
<li>Kubernetes Service Proxy들이 자동으로 서비스 리퀘스트를 pod에 연결함</li>
<li>Cluster 내에서 어디로 움직이든 또는 replace 되더라도 자동으로 연결 됨.</li>
</ul>
</li>
<li>Kubelet : 이 서비스는 노드에서 실행되며, 컨테이너 manifest를 읽고, 정의된 컨테이너들이 시작되고 작동하도록 함</li>
</ul>
</li>
<li>
<p>동작원리</p>
<ul>
<li>클러스터 : 동작 중인 쿠버네티스 deployment를 클러스터라고 합니다.
<ul>
<li>클러스터는 컨트롤 plane과 compute 머신(노드) 두가지 파트로 나눌 수 있습니다.
<ul>
<li>Control Plane + Worker nodes</li>
</ul>
</li>
<li>각각의 노드는 리눅스환경으로 볼 수 있으며, physical/virtual 머신입니다.</li>
<li>각각의 노드는 컨테이너들로 구성된 pod들을 실행합니다.</li>
<li>컨트롤러 플레인은 클러스터의 상태를 관리
<ul>
<li>어떤 어플리케이션이 실행되고 있는지, 어떤 컨테이너 이미지가 사용 되고 있는지 등</li>
<li>Compute 머신은 실제로 어플리케이션과 워크로드들을 실행 합니다.</li>
</ul>
</li>
</ul>
</li>
<li>쿠버네티스는 OS위에서 동작하면서 노드들위에 실행 중인 컨테이너 pod들과 interact 합니다.
<ul>
<li>컨트롤러플레인은 admin으로부터 커멘드를 받아, Compute머신에 해당 커멘드들을 적용합니다.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Youtube Tutorial (TechWorld with Nana)</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="" class="language-text"><code>- Deployment &gt; ReplicaSet &gt; Pod &gt; Container
  - use kubectl command to manage deployment

```sh
k get pod

k get services

k create deployment nginx-depl --image=nginx
k get deployment
k get pod
k get replicaset

k edit deployement nginx-depl
k get pod
  NAME                          READY   STATUS    RESTARTS   AGE
  nginx-depl-8475696677-c4p24   1/1     Running   0          3m33s
  mongo-depl-5ccf565747-xtp89   1/1     Running   0          2m10s

k logs nginx-depl-56cb8b6d7-6z9w6

k exec -it [pod name] -- bin/bash

k exec -it mongo-depl-5ccf565747-xtp89 -- bin/bash
k delete deployment mongo-depl
</code></pre><ul>
<li>microk8s 환경
<ul>
<li><a href="https://microk8s.io/docs/getting-started">https://microk8s.io/docs/getting-started</a></li>
<li><a href="https://ubuntu.com/tutorials/install-a-local-kubernetes-with-microk8s?&amp;_ga=2.260194125.1119864663.1678939258-1273102176.1678684219#1-overview">https://ubuntu.com/tutorials/install-a-local-kubernetes-with-microk8s?&amp;_ga=2.260194125.1119864663.1678939258-1273102176.1678684219#1-overview</a></li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code><span class="token function">sudo</span> snap <span class="token function">install</span> microk8s <span class="token parameter variable">--classic</span>

<span class="token comment"># 방화벽설정 {#방화벽설정 }</span>
<span class="token comment"># https://webdir.tistory.com/206 {#httpswebdirtistorycom206 }</span>

<span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-G</span> microk8s <span class="token environment constant">$USER</span>
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-R</span> <span class="token environment constant">$USER</span> ~/.kube
<span class="token function">su</span> - <span class="token environment constant">$USER</span>
microk8s status --wait-ready

<span class="token function">vim</span> .bashrc
  <span class="token builtin class-name">alias</span> <span class="token assign-left variable">k</span><span class="token operator">=</span><span class="token string">'microk8s kubectl'</span>
  <span class="token builtin class-name">alias</span> <span class="token assign-left variable">helm</span><span class="token operator">=</span><span class="token string">'microk8s helm'</span>

<span class="token builtin class-name">source</span> .bashrc
</code></pre><ul>
<li>
<p>Microk8s, Ingress, metallb, nginx controller로 외부 서비스 만들기</p>
<ul>
<li>참고 문서
<ul>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/</a></li>
<li><a href="https://benbrougher.tech/posts/microk8s-ingress/">https://benbrougher.tech/posts/microk8s-ingress/</a></li>
<li><a href="https://betterprogramming.pub/how-to-expose-your-services-with-kubernetes-ingress-7f34eb6c9b5a">https://betterprogramming.pub/how-to-expose-your-services-with-kubernetes-ingress-7f34eb6c9b5a</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Ingress는 쿠버네티스가 외부로 부터 트래픽을 받아서 내부 서비스로 route할 수 있도록 해줌</p>
<ul>
<li>호스트를 정의하고, 호스트내에서 sub-route를 통해</li>
<li>같은 호스트네임의 다른 서비스들로 route할 수 있도록 함</li>
<li>Ingress rule을 통해 하나의 Ip 주소로 들어오도록 설정</li>
<li>Ingress Controller가 실제 traffic route하며, Ingress는 rule을 정의하는 역할</li>
</ul>
</li>
<li>
<p>이미지 만들기 -&gt; Dockerhub에 push</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code><span class="token comment"># 이미지 만들기 {#이미지-만들기 }</span>
<span class="token builtin class-name">cd</span> learn/yaml/helloworld/docker
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> server-1:latest <span class="token parameter variable">-f</span> build/Dockerfile <span class="token builtin class-name">.</span>
<span class="token function">docker</span> tag server-1 jnuho/server-1
<span class="token function">docker</span> push jnuho/server-1
</code></pre><ul>
<li>simple-service.yaml</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hellok8s<span class="token punctuation">-</span>deployment
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> hellok8s
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> hellok8s
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> hellok8s
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hellok8s
        <span class="token key atrule">image</span><span class="token punctuation">:</span> jnuho/server<span class="token punctuation">-</span><span class="token number">1</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8081</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hellok8s<span class="token punctuation">-</span>service
  <span class="token comment"># Use specific ip for metallb</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">metallb.universe.tf/loadBalancerIPs</span><span class="token punctuation">:</span> 172.16.6.100
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> hellok8s
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8081</span>
</code></pre><pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code>k apply <span class="token parameter variable">-f</span> simple-service.yaml
k get svc
  NAME               TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
  kubernetes         ClusterIP      <span class="token number">10.152</span>.183.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>         <span class="token number">443</span>/TCP          5d19h
  hellok8s-service   LoadBalancer   <span class="token number">10.152</span>.183.58   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>         <span class="token number">8081</span>:31806/TCP   114s
</code></pre><pre data-role="codeBlock" data-info="sh" class="language-bash sh"><code><span class="token comment"># 사용중 ip인지 확인하기: 100-105 {#사용중-ip인지-확인하기-100-105 }</span>
<span class="token function">ping</span> <span class="token number">172.16</span>.6.100

microk8s <span class="token builtin class-name">enable</span> metallb:172.16.6.100-172.16.6.105

<span class="token comment"># 로드밸런서 서비스의 IP가 metallb에 의해 할당됨 {#로드밸런서-서비스의-ip가-metallb에-의해-할당됨 }</span>
<span class="token comment"># 172.16.6.100:8081로 애플리케이션 접근 {#1721661008081로-애플리케이션-접근 }</span>

k get svc
  NAME               TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
  kubernetes         ClusterIP      <span class="token number">10.152</span>.183.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>         <span class="token number">443</span>/TCP          5d19h
  hellok8s-service   LoadBalancer   <span class="token number">10.152</span>.183.58   <span class="token number">172.16</span>.6.100   <span class="token number">8081</span>:31806/TCP   114s

<span class="token comment"># 브라우저로 애플리케이션 접근 172.16.6.100:8081 {#브라우저로-애플리케이션-접근-1721661008081 }</span>
<span class="token function">curl</span> <span class="token number">172.16</span>.6.100:8081
</code></pre>
      </div>
      
      
    
    
    
    
    
    
  
    </body></html>